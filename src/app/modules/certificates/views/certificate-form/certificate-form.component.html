<mat-card class="certificate">
  <mat-card-content class="certificate__content">
    <form [formGroup]="certificateForm" (ngSubmit)="generateCertificate()" class="certificate__form">
      <!-- Sección 1: Datos del Estudiante -->
      <div class="form-section">
        <h3 class="section-title">Datos del Estudiante</h3>
        <div class="form-row full-width">
          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Nombre del Estudiante</mat-label>
            <input matInput formControlName="studentName" placeholder="Ingrese el nombre completo">
            @if (certificateForm.get('studentName')?.touched && certificateForm.get('studentName')?.errors) {
              <mat-error>El nombre es requerido y debe tener al menos 3 caracteres</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Tipo de Documento</mat-label>
            <mat-select formControlName="documentType">
              @for (type of documentTypes; track type.tipo) {
                <mat-option [value]="type.tipo">{{ type.tipo }}</mat-option>
              }
            </mat-select>
            @if (certificateForm.get('documentType')?.touched && certificateForm.get('documentType')?.errors) {
              <mat-error>Seleccione un tipo de documento</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Número de Documento</mat-label>
            <input matInput formControlName="documentNumber"
                   [attr.maxlength]="getMaxLength()"
                   placeholder="Ingrese el número de documento">
            @if (certificateForm.get('documentNumber')?.touched && certificateForm.get('documentNumber')?.errors) {
              <mat-error>{{ getDocumentErrorMessage() }}</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Lugar de Expedición</mat-label>
            <input matInput formControlName="expeditionPlace" placeholder="Ciudad de expedición">
            @if (certificateForm.get('expeditionPlace')?.touched && certificateForm.get('expeditionPlace')?.errors) {
              <mat-error>El lugar de expedición es requerido</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Correo Electrónico</mat-label>
            <input matInput type="email" formControlName="email" placeholder="ejemplo@correo.com">
            @if (certificateForm.get('email')?.touched && certificateForm.get('email')?.errors) {
              <mat-error>Ingrese un correo electrónico válido</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <!-- Sección 2: Datos del Curso -->
      <div class="form-section">
        <h3 class="section-title">Datos del Curso</h3>
        <div class="form-row full-width">
          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Nombre del Curso</mat-label>
            <input matInput formControlName="courseName" placeholder="Ingrese el nombre del curso">
            @if (certificateForm.get('courseName')?.touched && certificateForm.get('courseName')?.errors) {
              <mat-error>El nombre del curso es requerido</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Válido hasta el año</mat-label>
            <mat-select formControlName="validityYear">
              @for (year of validityYears; track year) {
                <mat-option [value]="year">{{ year }}</mat-option>
              }
            </mat-select>
            @if (certificateForm.get('validityYear')?.touched && certificateForm.get('validityYear')?.errors) {
              <mat-error>Seleccione el año de validez</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="certificate__field">
            <mat-label>Cantidad de Horas</mat-label>
            <input matInput type="number" formControlName="hours" placeholder="0" min="1">
            @if (certificateForm.get('hours')?.touched && certificateForm.get('hours')?.errors) {
              <mat-error>La cantidad de horas debe ser mayor a 0</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <div class="certificate__actions">
        <!-- Generate Certificate -->
        <button mat-raised-button color="primary" type="submit" [disabled]="!certificateForm.valid || isGenerating">
          <mat-icon>assignment</mat-icon>
          {{ isGenerating ? 'Generando...' : 'Generar Certificado' }}
        </button>

        <!-- Download PDF -->
        <button mat-raised-button color="accent" type="button" (click)="downloadCertificate()"
                [disabled]="!certificateGenerated || isGenerating">
          <mat-icon>download</mat-icon>
          {{ isGenerating ? 'Procesando...' : 'Descargar PDF' }}
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

@if (certificateGenerated) {
  <div #certificateElement class="certificate-preview">
    <div class="certificate-preview__content">
      <div class="content-wrapper">
        <div class="title-group">
          <h1 class="title">DE ASISTENCIA SEGÚN RESOLUCIÓN 3100 DE 2019</h1>
          <div class="company-info">NIT 9012123811 CDCREANIMARTE</div>
        </div>

        <div class="student-group">
          <h2 class="student-name">{{ certificateForm.get('studentName')?.value }}</h2>
          <div class="id-info">
            IDENTIFICADO CON {{ certificateForm.get('documentType')?.value }}:
            {{ certificateForm.get('documentNumber')?.value | mask: 'separator.2' }}
            DE {{ certificateForm.get('expeditionPlace')?.value | uppercase }}
          </div>
        </div>

        <div class="course-info">
          <div>Asistió y aprobó el curso</div>
          <div class="course-name">{{ certificateForm.get('courseName')?.value }}</div>
          <div>con una intensidad de {{ certificateForm.get('hours')?.value }} horas.</div>
        </div>

        <div class="firmas">
          <div class="representante">
            <img src="images/fir_rep_legal.jpg" alt="Firma">
            <div>Representante Legal</div>
          </div>

          <div class="director">
            <img src="images/fir_dir_general.jpg" alt="Firma">
            <div>Director General</div>
          </div>
        </div>

        <div class="verification-info">
          <p>Emitido: <span>{{ currentDate | date:'dd/MM/yyyy' }}</span></p>
          <p>Vigencia: <span>{{ currentDate | date:'yyyy' }} - {{yearSelected | date:'yyyy'}} </span></p>
          <p>Código: <span>{{ certificateCode }}</span></p>
          <p>Verificar: <a href="https://cdcreanimarte.github.io/certificaciones/">https://cdcreanimarte.github.io/certificaciones</a></p>
        </div>
      </div>
    </div>
  </div>
}
